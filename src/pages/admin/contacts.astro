---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Contact Submissions - Admin Panel">
  <div class="min-h-screen bg-gray-50 pb-20">
    <!-- Page Header -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
      <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
          <div class="flex-1 min-w-0">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Contact Submissions</h2>
            <p class="mt-1 text-xs sm:text-sm text-gray-500">View and manage contact form submissions</p>
          </div>
          <a href="/admin" class="flex items-center space-x-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-sm whitespace-nowrap">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            <span class="hidden sm:inline">Back to Dashboard</span>
            <span class="sm:hidden">Back</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
      <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-3 sm:py-4">
        <div class="flex items-center space-x-2 sm:space-x-3 overflow-x-auto">
          <select id="status-filter" class="px-3 sm:px-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg sm:rounded-xl text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 whitespace-nowrap">
            <option value="all">All Status</option>
            <option value="new">New</option>
            <option value="read">Read</option>
            <option value="replied">Replied</option>
            <option value="archived">Archived</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Contacts List -->
    <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-6">
      
      <div id="contacts-list" class="space-y-4">
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
            <svg class="w-8 h-8 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </div>
          <p class="text-gray-500 font-medium">Loading contact submissions...</p>
        </div>
      </div>
    </div>

    <!-- Contact Details Modal -->
    <div id="contact-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
        <div class="bg-white rounded-lg sm:rounded-xl shadow-xl max-w-2xl w-full p-4 sm:p-6 max-h-[95vh] overflow-y-auto">
          <div class="mb-6">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Contact Details</h3>
            <div class="space-y-3 text-sm">
              <div class="flex items-center justify-between border-b pb-2">
                <span class="text-gray-600 font-medium">Name:</span>
                <span id="modal-contact-name" class="text-gray-900"></span>
              </div>
              <div class="flex items-center justify-between border-b pb-2">
                <span class="text-gray-600 font-medium">Email:</span>
                <span id="modal-contact-email" class="text-gray-900"></span>
              </div>
              <div class="flex items-center justify-between border-b pb-2">
                <span class="text-gray-600 font-medium">Phone:</span>
                <span id="modal-contact-phone" class="text-gray-900"></span>
              </div>
              <div class="flex items-center justify-between border-b pb-2">
                <span class="text-gray-600 font-medium">Company:</span>
                <span id="modal-contact-company" class="text-gray-900"></span>
              </div>
              <div class="flex items-center justify-between border-b pb-2">
                <span class="text-gray-600 font-medium">Project Type:</span>
                <span id="modal-contact-project-type" class="text-gray-900"></span>
              </div>
              <div class="flex items-center justify-between border-b pb-2">
                <span class="text-gray-600 font-medium">Status:</span>
                <span id="modal-contact-status" class="text-gray-900"></span>
              </div>
              <div class="flex items-center justify-between border-b pb-2">
                <span class="text-gray-600 font-medium">Submitted:</span>
                <span id="modal-contact-created" class="text-gray-900"></span>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Project Details / Message</label>
            <div id="modal-contact-message" class="bg-gray-50 p-4 rounded-lg text-sm text-gray-700 max-h-60 overflow-y-auto"></div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Update Status</label>
            <select id="contact-status-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
              <option value="new">New</option>
              <option value="read">Read</option>
              <option value="replied">Replied</option>
              <option value="archived">Archived</option>
            </select>
          </div>

          <div class="flex justify-end space-x-3">
            <button onclick="closeContactDetailsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
              Close
            </button>
            <button onclick="updateContactStatus()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              Update Status
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://tguopyxmlfxcalhfitob.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW9weXhtbGZ4Y2FsaGZpdG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTk3NDQsImV4cCI6MjA3OTc5NTc0NH0.GUtJWVu8i6NWoleXI_Fd-ePM4vOFQtulyk1kqZgPgRM';
    
    let supabase = null;
    let allContacts = [];
    let currentContact = null;
    
    function waitForSupabase() {
      return new Promise((resolve) => {
        if (window.supabase && window.supabase.auth && typeof window.supabase.auth.getUser === 'function') {
          supabase = window.supabase;
          resolve(supabase);
        } 
        else if (window.supabase && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          resolve(supabase);
        } 
        else {
          setTimeout(() => waitForSupabase().then(resolve), 100);
        }
      });
    }
    
    async function loadContacts(statusFilter = 'all') {
      try {
        if (!supabase) {
          await waitForSupabase();
        }
        
        let query = supabase
          .from('contact_submissions')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (statusFilter !== 'all') {
          query = query.eq('status', statusFilter);
        }
        
        const { data: contacts, error } = await query;
        
        if (error) {
          console.error('Error loading contacts:', error);
          document.getElementById('contacts-list').innerHTML = '<div class="text-center py-12 text-red-500"><p>Error loading contacts.</p></div>';
          return;
        }
        
        allContacts = contacts || [];
        renderContacts(allContacts);
        
      } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contacts-list').innerHTML = '<div class="text-center py-12 text-red-500"><p>Error loading contacts.</p></div>';
      }
    }
    
    function renderContacts(contacts) {
      const contactsList = document.getElementById('contacts-list');
      
      if (contacts.length === 0) {
        contactsList.innerHTML = '<div class="text-center py-12 text-gray-500"><p>No contact submissions found.</p></div>';
        return;
      }
      
      contactsList.innerHTML = contacts.map(contact => {
        const statusColors = {
          'new': 'bg-blue-500',
          'read': 'bg-yellow-500',
          'replied': 'bg-green-500',
          'archived': 'bg-gray-500'
        };
        
        const fullName = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'N/A';
        const phone = contact.phone || contact.phone_number || 'N/A';
        
        return `
          <div class="bg-white border-2 border-gray-200 rounded-lg sm:rounded-xl p-4 sm:p-5 hover:border-blue-300 hover:shadow-lg transition-all duration-200 cursor-pointer" onclick="openContactDetails('${contact.id}')">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <h3 class="text-base sm:text-lg font-bold text-gray-900 break-words">${fullName}</h3>
                <p class="text-xs sm:text-sm text-gray-600 mt-1 truncate">${contact.email || 'No email'}</p>
                <p class="text-xs sm:text-sm text-gray-600 truncate">${phone}</p>
                <div class="flex items-center space-x-2 mt-2 flex-wrap">
                  <span class="px-2 sm:px-3 py-1 text-xs font-semibold text-white rounded-full ${statusColors[contact.status] || 'bg-gray-500'} whitespace-nowrap">
                    ${contact.status || 'N/A'}
                  </span>
                  <span class="px-2 sm:px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-100 rounded-full whitespace-nowrap">
                    ${contact.project_type || 'N/A'}
                  </span>
                </div>
                <div class="flex items-center text-xs text-gray-500 mt-2">
                  <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span class="truncate">${new Date(contact.created_at).toLocaleString()}</span>
                </div>
              </div>
              <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function openContactDetails(contactId) {
      const contact = allContacts.find(c => c.id === contactId);
      if (!contact) return;
      
      currentContact = contact;
      
      const fullName = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'N/A';
      const phone = contact.phone || contact.phone_number || 'N/A';
      const message = contact.message || contact.project_details || 'No message';
      
      document.getElementById('modal-contact-name').textContent = fullName;
      document.getElementById('modal-contact-email').textContent = contact.email || 'N/A';
      document.getElementById('modal-contact-phone').textContent = phone;
      document.getElementById('modal-contact-company').textContent = contact.company_name || 'N/A';
      document.getElementById('modal-contact-project-type').textContent = contact.project_type || 'N/A';
      document.getElementById('modal-contact-status').textContent = contact.status || 'N/A';
      document.getElementById('modal-contact-created').textContent = contact.created_at ? new Date(contact.created_at).toLocaleString() : 'N/A';
      document.getElementById('modal-contact-message').textContent = message;
      document.getElementById('contact-status-select').value = contact.status || 'new';
      
      document.getElementById('contact-details-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeContactDetailsModal() {
      document.getElementById('contact-details-modal').classList.add('hidden');
      document.body.style.overflow = '';
      currentContact = null;
    }
    
    async function updateContactStatus() {
      try {
        if (!currentContact) return;
        
        if (!supabase) {
          await waitForSupabase();
        }
        
        const newStatus = document.getElementById('contact-status-select').value;
        
        const { error } = await supabase
          .from('contact_submissions')
          .update({
            status: newStatus,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentContact.id);
        
        if (error) {
          console.error('Error updating contact:', error);
          alert('Error updating contact status');
          return;
        }
        
        alert('Status updated successfully!');
        closeContactDetailsModal();
        await loadContacts(document.getElementById('status-filter').value);
        
      } catch (error) {
        console.error('Error updating contact status:', error);
        alert('Error updating contact status');
      }
    }
    
    window.openContactDetails = openContactDetails;
    window.closeContactDetailsModal = closeContactDetailsModal;
    window.updateContactStatus = updateContactStatus;
    
    document.getElementById('status-filter').addEventListener('change', (e) => {
      loadContacts(e.target.value);
    });
    
    document.addEventListener('DOMContentLoaded', async () => {
      await waitForSupabase();
      await loadContacts();
    });
    
    document.getElementById('contact-details-modal').addEventListener('click', (e) => {
      if (e.target.id === 'contact-details-modal') {
        closeContactDetailsModal();
      }
    });
  </script>
</AdminLayout>

