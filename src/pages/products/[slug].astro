---
import Layout from '../../layouts/Layout.astro';
import { getProductBySlug, getProducts, getProductPlans } from '../../lib/products-data';

export async function getStaticPaths() {
  // Fallback image URLs map - defined inside function to avoid scope issues
  const FALLBACK_IMAGES: Record<string, string> = {
    'restaurant-menu-system': 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop&crop=center',
    'android-tv-app': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=300&fit=crop&crop=center',
    'streaming-mobile-app': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=300&fit=crop&crop=center',
    'restaurant-website': 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop&crop=center'
  };
  
  const DEFAULT_FALLBACK = 'https://images.unsplash.com/photo-1551434678-e076c223a692?w=400&h=300&fit=crop&crop=center';
  
  const products = await getProducts();
  
  const paths = await Promise.all(products.map(async (product) => {
    // Process product image inline to avoid scope issues
    let productImage = product.featured_image;
    if (!productImage || !productImage.startsWith('http')) {
      // Use fallback image based on slug
      productImage = FALLBACK_IMAGES[product.slug] || DEFAULT_FALLBACK;
    }
    
    return {
      params: { slug: product.slug },
      props: { 
        product: {
          ...product,
          featured_image: productImage
        }, 
        productPlans: await getProductPlans(product.id) 
      }
    };
  }));
  
  return paths;
}

// Fallback image URLs map for use in component
const FALLBACK_IMAGES: Record<string, string> = {
  'restaurant-menu-system': 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop&crop=center',
  'android-tv-app': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=300&fit=crop&crop=center',
  'streaming-mobile-app': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=300&fit=crop&crop=center',
  'restaurant-website': 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop&crop=center',
};

const DEFAULT_FALLBACK = 'https://images.unsplash.com/photo-1551434678-e076c223a692?w=400&h=300&fit=crop&crop=center';

const { product: rawProduct, productPlans } = Astro.props;
const { slug } = Astro.params;

// Ensure product has a valid image
let productImage = rawProduct.featured_image;
if (!productImage || !productImage.startsWith('http')) {
  // Use fallback image based on slug
  productImage = FALLBACK_IMAGES[rawProduct.slug] || DEFAULT_FALLBACK;
}

const product = {
  ...rawProduct,
  featured_image: productImage
};

if (!product) {
  return Astro.redirect('/products');
}

const categoryStyles = {
  restaurant: {
    gradient: 'from-blue-500 to-indigo-600',
    bg: 'bg-blue-50',
    text: 'text-blue-700',
    icon: 'üçΩÔ∏è'
  },
  mobile: {
    gradient: 'from-blue-500 to-indigo-600',
    bg: 'bg-blue-50',
    text: 'text-blue-700',
    icon: 'üì±'
  },
  tv: {
    gradient: 'from-purple-500 to-violet-600',
    bg: 'bg-purple-50',
    text: 'text-purple-700',
    icon: 'üì∫'
  },
  web: {
    gradient: 'from-orange-500 to-red-600',
    bg: 'bg-orange-50',
    text: 'text-orange-700',
    icon: 'üåê'
  }
};

// Special styling for Restaurant Menu System
const isRestaurantMenuSystem = product.slug === 'restaurant-menu-system';
const restaurantMenuGradient = 'from-blue-600 via-blue-700 to-indigo-800';
const restaurantMenuBg = 'bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-100';

// Special styling for Android TV App
const isAndroidTVApp = product.slug === 'android-tv-app';
const androidTVGradient = 'from-purple-600 via-purple-700 to-violet-800';
const androidTVBg = 'bg-gradient-to-br from-purple-50 via-violet-50 to-purple-100';

// Special styling for Streaming Mobile App
const isStreamingMobileApp = product.slug === 'streaming-mobile-app';
const streamingMobileGradient = 'from-pink-500 via-rose-600 to-pink-700';
const streamingMobileBg = 'bg-gradient-to-br from-pink-50 via-rose-50 to-pink-100';
const streamingMobileBottomGradient = 'from-pink-600 via-rose-700 to-pink-800';

// Special styling for Restaurant Website
const isRestaurantWebsite = product.slug === 'restaurant-website';
const restaurantWebsiteGradient = 'from-emerald-600 via-teal-700 to-cyan-800';
const restaurantWebsiteBg = 'bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100';
const restaurantWebsiteBottomGradient = 'from-emerald-700 via-teal-800 to-cyan-900';


const style = categoryStyles[product.category];
---

<style>
  /* Prevent text color flickering on page load */
  .restaurant-menu-system-page {
    color: #1e40af !important;
  }
  
  .android-tv-app-page {
    color: #7c3aed !important;
  }
  
  .streaming-mobile-app-page {
    color: #be185d !important;
  }
  
  .restaurant-website-page {
    color: #065f46 !important;
  }
  
  /* Ensure text colors are applied immediately */
  .restaurant-menu-system-page h1,
  .restaurant-menu-system-page h2,
  .restaurant-menu-system-page h3,
  .restaurant-menu-system-page p,
  .restaurant-menu-system-page span {
    color: inherit !important;
  }
  
  .android-tv-app-page h1,
  .android-tv-app-page h2,
  .android-tv-app-page h3,
  .android-tv-app-page p,
  .android-tv-app-page span {
    color: inherit !important;
  }
  
  .streaming-mobile-app-page h1,
  .streaming-mobile-app-page h2,
  .streaming-mobile-app-page h3,
  .streaming-mobile-app-page p,
  .streaming-mobile-app-page span {
    color: inherit !important;
  }
  
  .restaurant-website-page h1,
  .restaurant-website-page h2,
  .restaurant-website-page h3,
  .restaurant-website-page p,
  .restaurant-website-page span {
    color: inherit !important;
  }
  
</style>

<Layout title={`${product.name} - DevExpress`} description={product.description}>
    <!-- Immediate auth check script to prevent content flash -->
    <script is:inline>
      (function() {
        // Hide content immediately - ALL products require authentication
        const currentPath = window.location.pathname;
        const productSlug = currentPath.split('/').pop();
        
        // Check if this is Android TV App - accessible to all logged-in users
        const isAndroidTVApp = productSlug === 'android-tv-app';
        
        // List of blocked/disabled products that show dialog instead of login
        const blockedProducts = [
          'restaurant-menu-system',
          'streaming-mobile-app',
          'restaurant-website'
        ];
        
        // FIRST: Check if product is blocked - if so, show page and dialog without auth check
        const isBlockedProduct = blockedProducts.includes(productSlug);
        
        if (isBlockedProduct) {
          console.log('üö´ Blocked product detected - showing page and dialog without login requirement');
          // Show page content immediately
          if (document.body) {
            document.body.style.opacity = '1';
          }
          if (document.documentElement) {
            document.documentElement.style.opacity = '1';
          }
          // Show dialog when DOM is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
              if (window.showProductDialog) {
                window.showProductDialog();
              }
            });
          } else {
            setTimeout(() => {
              if (window.showProductDialog) {
                window.showProductDialog();
              }
            }, 100);
          }
          return; // Exit early - no auth check needed
        }
        
        // ALL products require authentication - no exceptions
        // Hide body content immediately to prevent flash - CRITICAL: Do this first
        if (document.body) {
          document.body.style.opacity = '0';
          document.body.style.transition = 'opacity 0.3s ease-out';
        }
        
        // Also hide html element to prevent any flash
        if (document.documentElement) {
          document.documentElement.style.opacity = '0';
          document.documentElement.style.transition = 'opacity 0.3s ease-out';
        }
        
        // Check auth status with retries
        const checkAuth = () => {
          const authManager = window.globalAuthManager || window.simpleAuthManager;
          const sessionData = sessionStorage.getItem('simple-auth-session');
          const hasValidSession = sessionData && sessionData !== 'null' && sessionData !== '{}';
          
          // Quick check: if we have session data, user might be logged in
          // If no session data at all, redirect immediately without waiting
          if (!sessionData || sessionData === 'null' || sessionData === '{}') {
            // No session data - redirect immediately with smooth transition
            if (document.body) {
              document.body.style.transition = 'opacity 0.3s ease-out';
              document.body.style.opacity = '0';
            }
            if (document.documentElement) {
              document.documentElement.style.transition = 'opacity 0.3s ease-out';
              document.documentElement.style.opacity = '0';
            }
            setTimeout(() => {
              window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
            }, 200);
            return;
          }
          
          // If auth manager not ready, retry (increase retries for production)
          if (!authManager) {
            // Only retry, but increase retry count for production environments
            if (typeof checkAuth.retryCount === 'undefined') {
              checkAuth.retryCount = 0;
            }
            checkAuth.retryCount++;
            
            const maxRetries = 10;
            const retryDelay = checkAuth.retryCount < 10 ? 50 : 100;
            
            if (checkAuth.retryCount < maxRetries) {
              setTimeout(checkAuth, retryDelay);
            } else {
              // Too many retries - redirect to login
              if (document.body) {
                document.body.style.transition = 'opacity 0.3s ease-out';
                document.body.style.opacity = '0';
              }
              if (document.documentElement) {
                document.documentElement.style.transition = 'opacity 0.3s ease-out';
                document.documentElement.style.opacity = '0';
              }
              setTimeout(() => {
                window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
              }, 200);
            }
            return;
          }
          
          const isLoggedIn = authManager.isUserLoggedIn() && hasValidSession;
          
          if (!isLoggedIn) {
            // Redirect to login with smooth transition
            if (document.body) {
              document.body.style.transition = 'opacity 0.3s ease-out';
              document.body.style.opacity = '0';
            }
            if (document.documentElement) {
              document.documentElement.style.transition = 'opacity 0.3s ease-out';
              document.documentElement.style.opacity = '0';
            }
            setTimeout(() => {
              window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
            }, 200);
            return;
          }
          
          // User is logged in - check if Android TV App
          const isAndroidTVApp = productSlug === 'android-tv-app';
          
          if (isAndroidTVApp) {
            // Android TV App - allow access for all logged-in users
            console.log('‚úÖ Android TV App - allowing access for logged-in user');
            if (document.body) {
              document.body.style.transition = 'opacity 0.3s ease-in';
              document.body.style.opacity = '1';
            }
            if (document.documentElement) {
              document.documentElement.style.transition = 'opacity 0.3s ease-in';
              document.documentElement.style.opacity = '1';
            }
            return;
          }
          
          // User is logged in - show content smoothly (for other products)
          if (document.body) {
            document.body.style.transition = 'opacity 0.3s ease-in';
            document.body.style.opacity = '1';
          }
          if (document.documentElement) {
            document.documentElement.style.transition = 'opacity 0.3s ease-in';
            document.documentElement.style.opacity = '1';
          }
        };
        
        // Start checking immediately
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', checkAuth);
        } else {
          checkAuth();
        }
        
        // Also check when auth manager might be ready (with delays - increased for production)
        setTimeout(checkAuth, 100);
        setTimeout(checkAuth, 300);
        setTimeout(checkAuth, 500);
        setTimeout(checkAuth, 1000);
      })();
    </script>
    
    <!-- Full Page Gradient Background for Special Products -->
    <div class={`${isRestaurantMenuSystem ? 'bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-100 min-h-screen restaurant-menu-system-page' : ''} ${isAndroidTVApp ? 'bg-gradient-to-br from-purple-50 via-violet-50 to-purple-100 min-h-screen android-tv-app-page' : ''} ${isStreamingMobileApp ? 'bg-gradient-to-br from-pink-50 via-rose-50 to-pink-100 min-h-screen streaming-mobile-app-page' : ''} ${isRestaurantWebsite ? 'bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100 min-h-screen restaurant-website-page' : ''}`} style="color: ${isRestaurantMenuSystem ? '#1e40af' : isAndroidTVApp ? '#7c3aed' : isStreamingMobileApp ? '#be185d' : isRestaurantWebsite ? '#065f46' : 'inherit'};">
  <!-- Hero Section -->
  <section class={`bg-gradient-to-br ${isRestaurantMenuSystem ? restaurantMenuGradient : isAndroidTVApp ? androidTVGradient : isStreamingMobileApp ? streamingMobileGradient : isRestaurantWebsite ? restaurantWebsiteGradient : style.gradient} text-white py-20`}>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
        <div>
          <div class="flex items-center space-x-2 mb-4">
            <span class="text-2xl">{style.icon}</span>
            <span class="text-lg opacity-90 capitalize">{product.category} Solution</span>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold mb-6">{product.name}</h1>
          <p class="text-xl text-gray-100 mb-8">{product.description}</p>
          <div class="flex items-center space-x-6">
            <div class="text-center">
              <div class="text-3xl font-bold">24hrs</div>
              <div class="text-sm opacity-90">Delivery Time</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold">100%</div>
              <div class="text-sm opacity-90">Custom Built</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold">30d</div>
              <div class="text-sm opacity-90">Free Support</div>
            </div>
          </div>
        </div>
        <div class="relative">
          <img 
            src={product.featured_image} 
            alt={product.name} 
            class="rounded-lg shadow-2xl product-detail-image" 
            data-product-slug={product.slug}
            onerror={`this.onerror=null; this.src='${FALLBACK_IMAGES[product.slug] || DEFAULT_FALLBACK}';`}
          />
          <div class="absolute -bottom-6 -right-6 bg-white p-4 rounded-lg shadow-lg">
            <div class="text-2xl font-bold text-gray-900">
              {isAndroidTVApp ? '¬£99.00' : `‚Çπ${product.base_price.toLocaleString()}`}
            </div>
            <div class="text-sm text-gray-600">Starting Price</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Features Section -->
  <section class={`py-16 ${isRestaurantMenuSystem ? restaurantMenuBg : isAndroidTVApp ? androidTVBg : isStreamingMobileApp ? streamingMobileBg : isRestaurantWebsite ? restaurantWebsiteBg : ''}`}>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class={`text-3xl font-bold text-center mb-12 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>What's Included</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {product.features.map((feature, index) => (
          <div class={`${isRestaurantMenuSystem ? 'bg-white/80 backdrop-blur-sm border border-blue-200' : isAndroidTVApp ? 'bg-white/80 backdrop-blur-sm border border-purple-200' : isStreamingMobileApp ? 'bg-white/80 backdrop-blur-sm border border-pink-200' : isRestaurantWebsite ? 'bg-white/80 backdrop-blur-sm border border-emerald-200' : style.bg} p-6 rounded-lg animate-fade-in shadow-lg`} style={`animation-delay: ${index * 0.1}s;`}>
            <div class="flex items-center space-x-3">
              <div class={`w-8 h-8 bg-gradient-to-r ${isRestaurantMenuSystem ? restaurantMenuGradient : isAndroidTVApp ? androidTVGradient : isStreamingMobileApp ? streamingMobileGradient : isRestaurantWebsite ? restaurantWebsiteGradient : style.gradient} rounded-full flex items-center justify-center`}>
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
              <span class={`font-medium ${isRestaurantMenuSystem ? 'text-blue-800' : isAndroidTVApp ? 'text-purple-800' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : style.text}`}>{feature}</span>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Cuisine Type Section (Only for Restaurant Products) -->
  {product.category === 'restaurant' && (
    <section class={`py-16 ${isRestaurantMenuSystem ? 'bg-gradient-to-b from-blue-50 to-indigo-50' : ''}`}>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">Perfect for Any Cuisine</h2>
          <p class="text-xl text-gray-600">Our restaurant solutions work beautifully for all types of cuisines</p>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
          <div class={`${isRestaurantMenuSystem ? 'bg-white/80 backdrop-blur-sm border border-blue-200' : style.bg} p-4 rounded-lg text-center hover:shadow-md transition-shadow`}>
            <div class="text-2xl mb-2">üçõ</div>
            <div class={`font-medium ${isRestaurantMenuSystem ? 'text-blue-800' : style.text} text-sm`}>Indian</div>
          </div>
          <div class={`${isRestaurantMenuSystem ? 'bg-white/80 backdrop-blur-sm border border-blue-200' : style.bg} p-4 rounded-lg text-center hover:shadow-md transition-shadow`}>
            <div class="text-2xl mb-2">ü•¢</div>
            <div class={`font-medium ${isRestaurantMenuSystem ? 'text-blue-800' : style.text} text-sm`}>Chinese</div>
          </div>
          <div class={`${isRestaurantMenuSystem ? 'bg-white/80 backdrop-blur-sm border border-blue-200' : style.bg} p-4 rounded-lg text-center hover:shadow-md transition-shadow`}>
            <div class="text-2xl mb-2">üçù</div>
            <div class={`font-medium ${isRestaurantMenuSystem ? 'text-blue-800' : style.text} text-sm`}>Italian</div>
          </div>
          <div class={`${isRestaurantMenuSystem ? 'bg-white/80 backdrop-blur-sm border border-blue-200' : style.bg} p-4 rounded-lg text-center hover:shadow-md transition-shadow`}>
            <div class="text-2xl mb-2">üç£</div>
            <div class={`font-medium ${isRestaurantMenuSystem ? 'text-blue-800' : style.text} text-sm`}>Japanese</div>
          </div>
          <div class={`${isRestaurantMenuSystem ? 'bg-white/80 backdrop-blur-sm border border-blue-200' : style.bg} p-4 rounded-lg text-center hover:shadow-md transition-shadow`}>
            <div class="text-2xl mb-2">üåÆ</div>
            <div class={`font-medium ${isRestaurantMenuSystem ? 'text-blue-800' : style.text} text-sm`}>Mexican</div>
          </div>
          <div class={`${isRestaurantMenuSystem ? 'bg-white/80 backdrop-blur-sm border border-blue-200' : style.bg} p-4 rounded-lg text-center hover:shadow-md transition-shadow`}>
            <div class="text-2xl mb-2">üçï</div>
            <div class={`font-medium ${isRestaurantMenuSystem ? 'text-blue-800' : style.text} text-sm`}>Pizza</div>
          </div>
        </div>
        
        <div class="mt-8 text-center">
          <p class={`mb-4 ${isRestaurantMenuSystem ? 'text-gray-700' : 'text-gray-600'}`}>Don't see your cuisine type? No problem!</p>
          <p class={`text-sm ${isRestaurantMenuSystem ? 'text-black font-medium' : 'text-white'}`}>We customize our solutions to perfectly match your restaurant's unique style and cuisine</p>
        </div>
      </div>
    </section>
  )}



  <!-- Process Section -->
  <section class="py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class={`text-3xl font-bold mb-4 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>Development Process</h2>
        <p class={`text-xl ${isRestaurantMenuSystem ? 'text-blue-800' : isAndroidTVApp ? 'text-purple-800' : isStreamingMobileApp ? 'text-pink-700' : isRestaurantWebsite ? 'text-emerald-700' : 'text-gray-600'}`}>Here's how we deliver your {product.name.toLowerCase()} in 24 hours</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div class="text-center">
          <div class={`w-16 h-16 bg-gradient-to-r ${isRestaurantMenuSystem ? restaurantMenuGradient : isAndroidTVApp ? androidTVGradient : isStreamingMobileApp ? streamingMobileGradient : isRestaurantWebsite ? restaurantWebsiteGradient : style.gradient} rounded-full flex items-center justify-center mx-auto mb-4`}>
            <span class="text-white font-bold text-xl">1</span>
          </div>
          <h3 class={`text-lg font-semibold mb-2 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>Requirements</h3>
          <p class={`text-sm ${isRestaurantMenuSystem ? 'text-blue-800' : isAndroidTVApp ? 'text-purple-800' : isStreamingMobileApp ? 'text-pink-700' : isRestaurantWebsite ? 'text-emerald-700' : 'text-gray-600'}`}>You provide project details and requirements through our smart forms</p>
        </div>

        <div class="text-center">
          <div class={`w-16 h-16 bg-gradient-to-r ${isRestaurantMenuSystem ? restaurantMenuGradient : isAndroidTVApp ? androidTVGradient : isStreamingMobileApp ? streamingMobileGradient : isRestaurantWebsite ? restaurantWebsiteGradient : style.gradient} rounded-full flex items-center justify-center mx-auto mb-4`}>
            <span class="text-white font-bold text-xl">2</span>
          </div>
          <h3 class={`text-lg font-semibold mb-2 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>Design</h3>
          <p class={`text-sm ${isRestaurantMenuSystem ? 'text-blue-800' : isAndroidTVApp ? 'text-purple-800' : isStreamingMobileApp ? 'text-pink-700' : isRestaurantWebsite ? 'text-emerald-700' : 'text-gray-600'}`}>Our team creates custom designs based on your brand and preferences</p>
        </div>

        <div class="text-center">
          <div class={`w-16 h-16 bg-gradient-to-r ${isRestaurantMenuSystem ? restaurantMenuGradient : isAndroidTVApp ? androidTVGradient : isStreamingMobileApp ? streamingMobileGradient : isRestaurantWebsite ? restaurantWebsiteGradient : style.gradient} rounded-full flex items-center justify-center mx-auto mb-4`}>
            <span class="text-white font-bold text-xl">3</span>
          </div>
          <h3 class={`text-lg font-semibold mb-2 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>Development</h3>
          <p class={`text-sm ${isRestaurantMenuSystem ? 'text-blue-800' : isAndroidTVApp ? 'text-purple-800' : isStreamingMobileApp ? 'text-pink-700' : isRestaurantWebsite ? 'text-emerald-700' : 'text-gray-600'}`}>Rapid development using proven frameworks and best practices</p>
        </div>

        <div class="text-center">
          <div class={`w-16 h-16 bg-gradient-to-r ${isRestaurantMenuSystem ? restaurantMenuGradient : isAndroidTVApp ? androidTVGradient : isStreamingMobileApp ? streamingMobileGradient : isRestaurantWebsite ? restaurantWebsiteGradient : style.gradient} rounded-full flex items-center justify-center mx-auto mb-4`}>
            <span class="text-white font-bold text-xl">4</span>
          </div>
          <h3 class={`text-lg font-semibold mb-2 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>Delivery</h3>
          <p class={`text-sm ${isRestaurantMenuSystem ? 'text-blue-800' : isAndroidTVApp ? 'text-purple-800' : isStreamingMobileApp ? 'text-pink-700' : isRestaurantWebsite ? 'text-emerald-700' : 'text-gray-600'}`}>Complete solution delivered with documentation and support</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Product Plans Section -->
  (
    <section class="py-16">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class={`text-3xl font-bold text-center mb-12 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>Choose Your Plan</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {productPlans.map((plan) => (
            <div class={`${isRestaurantMenuSystem ? 'bg-white/90 backdrop-blur-sm border border-blue-200' : isAndroidTVApp ? 'bg-white/90 backdrop-blur-sm border border-purple-200' : isStreamingMobileApp ? 'bg-white/90 backdrop-blur-sm border border-pink-200' : isRestaurantWebsite ? 'bg-white/90 backdrop-blur-sm border border-emerald-200' : 'bg-white'} rounded-xl shadow-lg p-8 flex flex-col ${plan.is_popular ? 'ring-2 ring-primary-500 relative' : ''}`}>
              {plan.is_popular && (
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                  <span class="bg-primary-500 text-white px-4 py-2 rounded-full text-sm font-medium">Most Popular</span>
                </div>
              )}
              
              <div class="text-center mb-6">
                <h3 class={`text-xl font-bold mb-2 ${isRestaurantMenuSystem ? 'text-blue-900' : isAndroidTVApp ? 'text-purple-900' : isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>{plan.name}</h3>
                <p class={`text-sm mb-4 ${isRestaurantMenuSystem ? 'text-blue-800' : isAndroidTVApp ? 'text-purple-800' : isStreamingMobileApp ? 'text-pink-700' : isRestaurantWebsite ? 'text-emerald-700' : 'text-gray-600'}`}>{plan.description}</p>
                <div class="text-3xl font-bold text-primary-600">
                  {isAndroidTVApp && plan.name === 'Standard' ? '¬£99.00' : 
                   isAndroidTVApp && plan.name === 'Pro' ? '¬£299.00' :
                   isAndroidTVApp && plan.name === 'Pro Gold' ? '¬£449.00' :
                   `‚Çπ${plan.price.toLocaleString()}`}
                </div>
                {plan.delivery_days > 0 && (
                  <div class={`text-sm ${isRestaurantMenuSystem ? 'text-blue-700' : isAndroidTVApp ? 'text-purple-700' : isStreamingMobileApp ? 'text-pink-700' : isRestaurantWebsite ? 'text-emerald-700' : 'text-gray-500'}`}>Delivery in {plan.delivery_days} day{plan.delivery_days > 1 ? 's' : ''}</div>
                )}
              </div>
              
              <ul class="space-y-3 mb-8 flex-grow">
                {plan.features.map((feature) => (
                  <li class="flex items-center">
                    <svg class="w-5 h-5 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">{feature}</span>
                  </li>
                ))}
              </ul>
              
              <button 
                class={`choose-plan-btn w-full py-3 px-6 rounded-lg font-medium transition-all mt-auto ${
                  plan.is_popular 
                    ? 'bg-primary-600 hover:bg-primary-700 text-white' 
                    : 'bg-gray-100 hover:bg-gray-200 text-gray-900'
                }`}
                data-product-id={product.id}
                data-product-name={product.name}
                data-plan-price={plan.price}
                data-plan-name={plan.name}
                data-plan-id={plan.id || plan.name}
                data-plan-delivery-days={plan.delivery_days}
                data-plan-features={JSON.stringify(plan.features)}
                data-plan-description={plan.description || ''}
              >
                Choose {plan.name}
              </button>
              <p id={`login-required-${plan.id || plan.name}`} class="text-xs text-gray-500 mt-2 text-center" style="display: none;">
                <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                Login required to select
              </p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- FAQ Section -->
  <section class={`py-16 ${isStreamingMobileApp ? streamingMobileBg : isRestaurantWebsite ? restaurantWebsiteBg : ''}`}>
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class={`text-3xl font-bold text-center mb-12 ${isStreamingMobileApp ? 'text-pink-800' : isRestaurantWebsite ? 'text-emerald-800' : 'text-gray-900'}`}>Frequently Asked Questions</h2>
      
      <div class="space-y-6">
        <div class="bg-white rounded-lg shadow-sm">
          <button class="faq-button w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-50 transition-colors">
            <span class="font-semibold text-gray-900">How can you deliver in just 24 hours?</span>
            <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="faq-content hidden px-6 pb-4">
            <p class="text-gray-600">We use proven templates, pre-built components, and streamlined development processes. Our experienced team works around the clock to ensure rapid delivery without compromising quality.</p>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm">
          <button class="faq-button w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-50 transition-colors">
            <span class="font-semibold text-gray-900">What if I need revisions?</span>
            <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="faq-content hidden px-6 pb-4">
            <p class="text-gray-600">All plans include 30 days of free support and minor revisions. Major changes can be handled through our revision packages at affordable rates.</p>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm">
          <button class="faq-button w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-50 transition-colors">
            <span class="font-semibold text-gray-900">Do you provide source code?</span>
            <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="faq-content hidden px-6 pb-4">
            <p class="text-gray-600">Yes, you receive complete source code, documentation, and deployment instructions. You own the code and can modify it as needed.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class={`py-16 bg-gradient-to-r ${isStreamingMobileApp ? streamingMobileBottomGradient : isRestaurantWebsite ? restaurantWebsiteBottomGradient : style.gradient} text-white`}>
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl font-bold mb-4">Ready to Get Started?</h2>
      <p class="text-xl mb-8 opacity-90">
        Join hundreds of satisfied clients who got their {product.name.toLowerCase()} delivered in just 24 hours.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button 
          id="add-to-cart-btn"
          onclick={`redirectToCart('${product.id}', '${productPlans[0]?.price}')`}
          class="bg-white text-gray-900 hover:bg-gray-100 px-8 py-3 rounded-lg font-semibold transition-colors"
        >
          Add to Cart - ‚Çπ{productPlans[0]?.price.toLocaleString()}
        </button>
        <p class="text-xs text-white/70 mt-2 text-center">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
          Login required to add to cart
        </p>
        <a href={`/contact?product=${encodeURIComponent(product.name)}&project_type=${product.category}&project_details=${encodeURIComponent(`I'm interested in the ${product.name}. ${product.description}`)}&price=${productPlans[0]?.price || product.base_price}`} class="contact-us-btn border-2 border-white text-white hover:bg-white hover:text-black px-8 py-3 rounded-lg font-semibold transition-all">
          Contact Us
        </a>
      </div>
      
      <!-- Login Prompt for Unauthenticated Users -->
      <div id="login-prompt" class="hidden mt-6 p-4 bg-white bg-opacity-20 rounded-lg">
        <p class="text-white mb-3">Please sign in to add items to your cart</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <a href="/login?redirect=/products/${product.slug}" class="bg-white text-gray-900 hover:bg-gray-100 px-6 py-2 rounded-lg font-medium transition-colors">
            Sign In
          </a>
          <a href="/signup?redirect=/products/${product.slug}" class="border border-white text-white hover:bg-white hover:text-black px-6 py-2 rounded-lg font-medium transition-all" style="color: white !important;" onmouseover="this.style.color='black'" onmouseout="this.style.color='white'">
            Create Account
          </a>
        </div>
      </div>
    </div>
  </section>
  </div> <!-- End of full page gradient background -->

  <!-- Customization Form Modal -->
  <div id="customization-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
      <div class="flex flex-col lg:flex-row h-full">
        <!-- Left Side: Customization Form -->
        <div class="flex-1 p-8 bg-white">
          <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
              <h2 class="text-3xl font-bold text-gray-900">Upload Files</h2>
            </div>
            <button 
              id="close-customization-modal"
              class="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <form id="customization-form" class="space-y-6">
            <!-- User Information Section -->
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:border-primary-300 transition-colors">
              <div class="space-y-4">
                <!-- Name Field -->
                <div>
                  <label class="block text-gray-900 font-semibold mb-2 text-lg">
                    Name<span class="text-red-500 ml-1">*</span>
                  </label>
                  <input 
                    type="text" 
                    id="user-name" 
                    name="user_name" 
                    required
                    autocomplete="off"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-900 bg-white"
                    placeholder="Enter your name"
                  />
                </div>

                <!-- Email Field -->
                <div>
                  <label class="block text-gray-900 font-semibold mb-2 text-lg">
                    Email<span class="text-red-500 ml-1">*</span>
                  </label>
                  <input 
                    type="email" 
                    id="user-email" 
                    name="user_email" 
                    required
                    autocomplete="off"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-900 bg-white"
                    placeholder="Enter your email"
                  />
                </div>

                <!-- Phone Number Field -->
                <div>
                  <label class="block text-gray-900 font-semibold mb-2 text-lg">
                    Phone Number<span class="text-red-500 ml-1">*</span>
                  </label>
                  <input 
                    type="tel" 
                    id="user-phone" 
                    name="user_phone" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-900 bg-white"
                    readonly
                  />
                </div>
              </div>
            </div>

            <!-- Logo Upload Section -->
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:border-primary-300 transition-colors">
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex-1 min-w-[200px]">
                  <label class="block text-gray-900 font-semibold mb-2 text-lg">
                    Logo<span class="text-red-500 ml-1">*</span>
                  </label>
                  <p class="text-gray-600 text-sm">Size: Any Size</p>
                  <input 
                    type="file" 
                    id="logo-upload" 
                    name="logo" 
                    accept="image/*" 
                    required
                    class="hidden"
                  />
                  <p id="logo-file-name" class="text-primary-600 text-sm mt-2 hidden font-medium"></p>
                </div>
                <button 
                  type="button"
                  class="select-logo-btn bg-primary-600 hover:bg-primary-700 text-white px-8 py-3 rounded-lg font-medium transition-colors whitespace-nowrap shadow-sm hover:shadow-md"
                >
                  SELECT
                </button>
              </div>
            </div>

            <!-- Background/Wallpaper Upload Section -->
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:border-primary-300 transition-colors">
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex-1 min-w-[200px]">
                  <label class="block text-gray-900 font-semibold mb-2 text-lg">
                    Background/Wallpaper
                  </label>
                  <p class="text-gray-600 text-sm">Size: 1920x1080</p>
                  <input 
                    type="file" 
                    id="background-upload" 
                    name="background" 
                    accept="image/*"
                    class="hidden"
                  />
                  <p id="background-file-name" class="text-primary-600 text-sm mt-2 hidden font-medium"></p>
                </div>
                <button 
                  type="button"
                  class="select-background-btn bg-primary-600 hover:bg-primary-700 text-white px-8 py-3 rounded-lg font-medium transition-colors whitespace-nowrap shadow-sm hover:shadow-md"
                >
                  SELECT
                </button>
              </div>
            </div>

            <!-- Intro Video Upload Section (Only for Pro and Pro Gold plans) -->
            <div id="intro-video-section" class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:border-primary-300 transition-colors hidden">
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex-1 min-w-[200px]">
                  <label class="block text-gray-900 font-semibold mb-2 text-lg">
                    Intro Video on app start
                  </label>
                  <p class="text-gray-600 text-sm">3-8 Seconds, MP4 video</p>
                  <input 
                    type="file" 
                    id="intro-video-upload" 
                    name="intro_video" 
                    accept="video/mp4"
                    class="hidden"
                  />
                  <p id="intro-video-file-name" class="text-primary-600 text-sm mt-2 hidden font-medium"></p>
                </div>
                <button 
                  type="button"
                  class="select-intro-video-btn bg-primary-600 hover:bg-primary-700 text-white px-8 py-3 rounded-lg font-medium transition-colors whitespace-nowrap shadow-sm hover:shadow-md"
                >
                  SELECT
                </button>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end pt-6">
              <button 
                type="submit"
                class="bg-primary-600 hover:bg-primary-700 text-white px-10 py-3 rounded-lg font-semibold transition-colors text-lg shadow-md hover:shadow-lg"
              >
                SUBMIT AND MAKE PAYMENT
              </button>
            </div>
          </form>
        </div>

        <!-- Right Side: Selected Plan Details -->
        <div class="lg:w-96 bg-gray-50 p-8 border-l border-gray-200">
          <h3 class="text-2xl font-bold text-gray-900 mb-6">Selected Plan</h3>
          <div id="selected-plan-details" class="space-y-4">
            <!-- Plan details will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Declare global types
  declare global {
    interface Window {
      addToCart: (productId: string, planId: string, planName: string) => Promise<void>;
      showCustomizationForm: (productId: string, productName: string, price: number, planName: string, planId: string, planData: any) => void;
    }
  }

  // FAQ functionality
  document.querySelectorAll('.faq-button').forEach(button => {
    button.addEventListener('click', () => {
      const content = button.nextElementSibling;
      const icon = button.querySelector('svg');
      
      content.classList.toggle('hidden');
      icon.classList.toggle('rotate-180');
    });
  });

  // Plan selection button handlers
  function setupPlanSelectionHandlers() {
    const buttons = document.querySelectorAll('.choose-plan-btn');
    console.log('üîç Found plan selection buttons:', buttons.length);
    
    buttons.forEach((button, index) => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log(`üñ±Ô∏è Plan button ${index} clicked`);
        
        const productId = this.getAttribute('data-product-id');
        const productName = this.getAttribute('data-product-name');
        const planPrice = this.getAttribute('data-plan-price');
        const planName = this.getAttribute('data-plan-name');
        const planId = this.getAttribute('data-plan-id');
        const deliveryDays = this.getAttribute('data-plan-delivery-days');
        const featuresJson = this.getAttribute('data-plan-features');
        const description = this.getAttribute('data-plan-description');

        console.log('üìã Button data:', {
          productId,
          productName,
          planPrice,
          planName,
          planId,
          deliveryDays,
          featuresJson,
          description
        });

        if (!productId || !productName || !planPrice || !planName) {
          console.error('‚ùå Missing required plan data');
          return;
        }

        let features = [];
        try {
          features = featuresJson ? JSON.parse(featuresJson) : [];
        } catch (e) {
          console.error('Error parsing features:', e);
        }

        const planData = {
          name: planName,
          price: parseFloat(planPrice),
          delivery_days: deliveryDays ? parseInt(deliveryDays) : null,
          features: features,
          description: description || ''
        };

        console.log('üì¶ Plan data prepared:', planData);

        if (window.showCustomizationForm) {
          console.log('‚úÖ Calling showCustomizationForm');
          window.showCustomizationForm(productId, productName, parseFloat(planPrice), planName, planId || planName, planData);
        } else {
          console.error('‚ùå showCustomizationForm function not found on window object');
        }
      });
    });
  }

  // Setup handlers when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupPlanSelectionHandlers);
  } else {
    setupPlanSelectionHandlers();
  }
  
  // Also try after a short delay to ensure everything is loaded
  setTimeout(setupPlanSelectionHandlers, 500);

  // Show customization form - redirect to new page
  window.showCustomizationForm = function(productId: string, productName: string, price: number, planName: string, planId: string, planData: any) {
    console.log('üìù showCustomizationForm called with:', { productId, productName, price, planName, planId, planData });
    
    // Note: We don't need to check authentication here because:
    // 1. The product page itself already requires authentication (see inline script at top)
    // 2. If user can see the product page and click the button, they're already authenticated
    // 3. Adding another auth check here is redundant and can cause false negatives
    
    // Just log session info for debugging
    const sessionData = sessionStorage.getItem('simple-auth-session');
    const localUserData = localStorage.getItem('simple-auth-user');
    const authManager = window.globalAuthManager || window.simpleAuthManager;
    
    console.log('üîç Session info:', {
      hasSessionStorage: !!sessionData,
      hasLocalUser: !!localUserData,
      hasAuthManager: !!authManager,
      currentPath: window.location.pathname
    });

    // User is authenticated, redirect to customization page
    console.log('‚úÖ User authenticated, redirecting to customization page');
    
    // Get product slug from current URL
    const currentPath = window.location.pathname;
    const productSlug = currentPath.split('/').pop() || '';
    
    // Build URL with plan data
    const params = new URLSearchParams();
    params.set('productId', productId);
    params.set('productName', productName);
    params.set('productSlug', productSlug);
    params.set('price', price.toString());
    params.set('planName', planName);
    params.set('planId', planId);
    params.set('features', JSON.stringify(planData.features || []));
    params.set('description', planData.description || '');
    params.set('deliveryDays', (planData.delivery_days || 0).toString());
    
    // Redirect to customization page
    window.location.href = `/customize?${params.toString()}`;
  };

  // Close customization modal function
  function closeCustomizationModal() {
    const modal = document.getElementById('customization-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      console.log('‚úÖ Modal closed');
    }
  }

  // Setup close button handler
  document.addEventListener('DOMContentLoaded', () => {
    const closeModalBtn = document.getElementById('close-customization-modal');
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeCustomizationModal);
    }

    // Close modal when clicking outside
    const modal = document.getElementById('customization-modal');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeCustomizationModal();
        }
      });

      // Populate user info when modal is shown
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const isVisible = !modal.classList.contains('hidden') && modal.style.display !== 'none';
            if (isVisible) {
              // AUTOMATIC FETCH when modal becomes visible
              autoFetchAndPopulate();
              populateFromSession(); // Quick populate first
              setTimeout(() => forceSetFieldValues(), 50);
              setTimeout(() => populateUserInfo(), 100);
              setTimeout(() => forceSetFieldValues(), 150);
              setupFileUploadHandlers();
            }
          }
        });
      });

      observer.observe(modal, {
        attributes: true,
        attributeFilter: ['class', 'style']
      });

      // Also populate on initial load if modal is visible
      if (!modal.classList.contains('hidden') && modal.style.display !== 'none') {
        // AUTOMATIC FETCH when modal is visible
        autoFetchAndPopulate();
        populateFromSession(); // Quick populate first
        setTimeout(() => forceSetFieldValues(), 50);
        setTimeout(() => populateUserInfo(), 100);
        setTimeout(() => populateUserInfo(), 500);
        setTimeout(() => forceSetFieldValues(), 150);
        setTimeout(() => forceSetFieldValues(), 300);
      }
    }

    // AUTOMATIC FETCH - runs immediately
    autoFetchAndPopulate();
    // Quick populate immediately, then full populate with delays
    populateFromSession();
    setTimeout(() => forceSetFieldValues(), 50);
    setTimeout(() => populateUserInfo(), 100);
    setTimeout(() => populateUserInfo(), 500);
    setTimeout(() => populateUserInfo(), 1000);
    setTimeout(() => populateUserInfo(), 2000);
    // Keep forcing values to persist
    setTimeout(() => forceSetFieldValues(), 150);
    setTimeout(() => forceSetFieldValues(), 300);
    setTimeout(() => forceSetFieldValues(), 600);
    setTimeout(() => forceSetFieldValues(), 1200);
    setTimeout(() => forceSetFieldValues(), 2500);
  });
  
  // Also try quick populate on window load
  window.addEventListener('load', () => {
    // AUTOMATIC FETCH on window load
    autoFetchAndPopulate();
    setTimeout(() => populateFromSession(), 50);
    setTimeout(() => forceSetFieldValues(), 100);
    setTimeout(() => populateUserInfo(), 500);
    setTimeout(() => forceSetFieldValues(), 600);
    setTimeout(() => forceSetFieldValues(), 1000);
  });

  // Listen for user login events and repopulate
  window.addEventListener('user-logged-in', () => {
    console.log('üîÑ User logged in event detected, repopulating fields...');
    setTimeout(populateFromSession, 100);
    setTimeout(populateUserInfo, 500);
  });

  // Continuous check to ensure fields are populated (runs every 2 seconds until populated)
  function ensureFieldsPopulated() {
    const nameField = document.getElementById('user-name') as HTMLInputElement;
    const emailField = document.getElementById('user-email') as HTMLInputElement;
    
    if (nameField && emailField) {
      const hasName = nameField.value && nameField.value.trim().length > 0;
      const hasEmail = emailField.value && emailField.value.trim().length > 0;
      
      if (!hasName || !hasEmail) {
        console.log('üîÑ Fields not fully populated, retrying...', {
          hasName,
          hasEmail,
          nameValue: nameField.value,
          emailValue: emailField.value
        });
        populateFromSession();
        populateUserInfo();
        
        // Keep checking for up to 10 seconds
        if (typeof (window as any).populateCheckCount === 'undefined') {
          (window as any).populateCheckCount = 0;
        }
        (window as any).populateCheckCount++;
        
        if ((window as any).populateCheckCount < 5) {
          setTimeout(ensureFieldsPopulated, 2000);
        } else {
          console.log('‚èπÔ∏è Stopped checking after 10 seconds');
          delete (window as any).populateCheckCount;
        }
      } else {
        console.log('‚úÖ Fields are populated:', {
          name: nameField.value,
          email: emailField.value
        });
        delete (window as any).populateCheckCount;
      }
    }
  }

  // Start continuous check after a short delay
  setTimeout(() => {
    ensureFieldsPopulated();
  }, 1000);

  // Watch for field value changes and restore if cleared
  function watchFieldChanges() {
    const nameField = document.getElementById('user-name') as HTMLInputElement;
    const emailField = document.getElementById('user-email') as HTMLInputElement;
    
    if (!nameField || !emailField) {
      setTimeout(watchFieldChanges, 500);
      return;
    }

    let lastNameValue = nameField.value || '';
    let lastEmailValue = emailField.value || '';

    // Watch for value changes
    const checkValues = () => {
      const currentName = nameField.value || '';
      const currentEmail = emailField.value || '';

      // If name was cleared but we had a value before, restore it
      if (lastNameValue && !currentName && nameField.value !== lastNameValue) {
        console.warn('üîÑ Name field was cleared! Restoring:', lastNameValue);
        nameField.value = lastNameValue;
        nameField.setAttribute('value', lastNameValue);
      } else if (currentName) {
        lastNameValue = currentName;
      }

      // If email was cleared but we had a value before, restore it
      if (lastEmailValue && !currentEmail && emailField.value !== lastEmailValue) {
        console.warn('üîÑ Email field was cleared! Restoring:', lastEmailValue);
        emailField.value = lastEmailValue;
        emailField.setAttribute('value', lastEmailValue);
      } else if (currentEmail) {
        lastEmailValue = currentEmail;
      }
    };

    // Check every 500ms
    setInterval(checkValues, 500);

    // Also watch for attribute changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
          checkValues();
        }
      });
    });

    observer.observe(nameField, { attributes: true, attributeFilter: ['value'] });
    observer.observe(emailField, { attributes: true, attributeFilter: ['value'] });

    console.log('üëÄ Started watching field changes');
  }

  // Start watching after fields are populated
  setTimeout(watchFieldChanges, 2000);

  // Wait for Supabase to be ready
  async function waitForSupabase(maxRetries = 20, delay = 200) {
    for (let i = 0; i < maxRetries; i++) {
      if ((window as any).supabase && (window as any).supabase.from) {
        return (window as any).supabase;
      }
      await new Promise(resolve => setTimeout(resolve, delay));
    }
    return null;
  }

  // Automatic fetch function - gets user data from multiple sources
  async function autoFetchUserData() {
    try {
      console.log('üîÑ Auto-fetching user data...');
      
      // Source 1: sessionStorage (most recent)
      let userData = null;
      const sessionData = sessionStorage.getItem('simple-auth-session');
      if (sessionData) {
        try {
          const session = JSON.parse(sessionData);
          if (session && session.user) {
            userData = session.user;
            console.log('‚úÖ Found user in sessionStorage:', userData.email);
          }
        } catch (e) {
          console.error('Error parsing sessionStorage:', e);
        }
      }
      
      // Source 2: localStorage (fallback)
      if (!userData) {
        const localUserData = localStorage.getItem('simple-auth-user');
        if (localUserData) {
          try {
            userData = JSON.parse(localUserData);
            console.log('‚úÖ Found user in localStorage:', userData.email);
          } catch (e) {
            console.error('Error parsing localStorage:', e);
          }
        }
      }
      
      // Source 3: Auth Manager
      if (!userData) {
        const authManager = window.globalAuthManager || window.simpleAuthManager;
        if (authManager && authManager.isUserLoggedIn && authManager.isUserLoggedIn()) {
          userData = authManager.getCurrentUser();
          if (userData) {
            console.log('‚úÖ Found user in auth manager:', userData.email);
          }
        }
      }
      
      // Source 4: Fetch from Supabase profiles table if we have user ID
      if (userData && userData.id) {
        const supabase = await waitForSupabase();
        if (supabase) {
          try {
            const { data: profile, error } = await supabase
              .from('profiles')
              .select('full_name, email, phone')
              .eq('id', userData.id)
              .single();
            
            if (!error && profile) {
              // Merge Supabase profile data with session data
              userData = {
                ...userData,
                full_name: profile.full_name || userData.full_name,
                email: profile.email || userData.email,
                phone: profile.phone || userData.phone
              };
              console.log('‚úÖ Fetched profile from Supabase:', userData);
            }
          } catch (e) {
            console.error('Error fetching from Supabase:', e);
          }
        }
      }
      
      return userData;
    } catch (error) {
      console.error('Error in autoFetchUserData:', error);
      return null;
    }
  }

  // Function to force set values and ensure they persist
  async function forceSetFieldValues() {
    const nameField = document.getElementById('user-name') as HTMLInputElement;
    const emailField = document.getElementById('user-email') as HTMLInputElement;
    const phoneField = document.getElementById('user-phone') as HTMLInputElement;
    
    if (!nameField || !emailField || !phoneField) {
      return;
    }
    
    // Auto-fetch user data from all sources
    const userData = await autoFetchUserData();
    
    if (userData) {
      const name = userData.full_name || userData.name || '';
      const email = userData.email || '';
      const phone = userData.phone || '';
      
      // Force set name with multiple methods
      if (name) {
        nameField.value = name;
        nameField.setAttribute('value', name);
        nameField.defaultValue = name;
        try {
          Object.defineProperty(nameField, 'value', {
            value: name,
            writable: true,
            configurable: true
          });
        } catch (e) {
          nameField.value = name;
        }
        nameField.dispatchEvent(new Event('input', { bubbles: true }));
        nameField.dispatchEvent(new Event('change', { bubbles: true }));
        console.log('üîß Force set name:', name);
      }
      
      // Force set email with multiple methods
      if (email) {
        emailField.value = email;
        emailField.setAttribute('value', email);
        emailField.defaultValue = email;
        try {
          Object.defineProperty(emailField, 'value', {
            value: email,
            writable: true,
            configurable: true
          });
        } catch (e) {
          emailField.value = email;
        }
        emailField.dispatchEvent(new Event('input', { bubbles: true }));
        emailField.dispatchEvent(new Event('change', { bubbles: true }));
        console.log('üîß Force set email:', email);
      }
      
      // Force set phone with multiple methods
      if (phone) {
        phoneField.value = phone;
        phoneField.setAttribute('value', phone);
        phoneField.defaultValue = phone;
        phoneField.dispatchEvent(new Event('input', { bubbles: true }));
        phoneField.dispatchEvent(new Event('change', { bubbles: true }));
        console.log('üîß Force set phone:', phone);
      }
    } else {
      // Fallback: Try sessionStorage directly
      const sessionData = sessionStorage.getItem('simple-auth-session');
      if (sessionData) {
        try {
          const session = JSON.parse(sessionData);
          if (session && session.user) {
            const user = session.user;
            const name = user.full_name || user.name || '';
            const email = user.email || '';
            const phone = user.phone || '';
            
            if (name) {
              nameField.value = name;
              nameField.setAttribute('value', name);
              console.log('üîß Force set name (fallback):', name);
            }
            
            if (email) {
              emailField.value = email;
              emailField.setAttribute('value', email);
              console.log('üîß Force set email (fallback):', email);
            }
            
            if (phone) {
              phoneField.value = phone;
              phoneField.setAttribute('value', phone);
              console.log('üîß Force set phone (fallback):', phone);
            }
          }
        } catch (e) {
          console.error('Error in forceSetFieldValues fallback:', e);
        }
      }
    }
  }

  // AUTOMATIC FETCH AND POPULATE - Runs immediately and continuously
  async function autoFetchAndPopulate() {
    console.log('üöÄ Starting automatic fetch and populate...');
    
    // Wait for fields to be available
    let attempts = 0;
    const maxAttempts = 20;
    
    const checkAndPopulate = async () => {
      const nameField = document.getElementById('user-name') as HTMLInputElement;
      const emailField = document.getElementById('user-email') as HTMLInputElement;
      const phoneField = document.getElementById('user-phone') as HTMLInputElement;
      
      if (nameField && emailField && phoneField) {
        // Fields are ready, fetch and populate
        await forceSetFieldValues();
        console.log('‚úÖ Auto-populated fields');
        return true;
      } else {
        attempts++;
        if (attempts < maxAttempts) {
          setTimeout(checkAndPopulate, 100);
        } else {
          console.warn('‚ö†Ô∏è Fields not found after', maxAttempts, 'attempts');
        }
        return false;
      }
    };
    
    await checkAndPopulate();
  }

  // Quick population from session data (runs immediately)
  function populateFromSession() {
    try {
      const nameField = document.getElementById('user-name') as HTMLInputElement;
      const emailField = document.getElementById('user-email') as HTMLInputElement;
      const phoneField = document.getElementById('user-phone') as HTMLInputElement;

      if (!nameField || !emailField || !phoneField) {
        console.log('‚è≥ Fields not ready, will retry...');
        setTimeout(populateFromSession, 100);
        return;
      }

      // Get data from sessionStorage immediately
      const sessionData = sessionStorage.getItem('simple-auth-session');
      if (sessionData) {
        try {
          const session = JSON.parse(sessionData);
          console.log('üîç Session data for quick populate:', session);
          
          if (session && session.user) {
            const user = session.user;
            console.log('üë§ User data found:', {
              email: user.email,
              full_name: user.full_name,
              name: user.name,
              phone: user.phone
            });
            
            // Populate Name - try multiple sources
            if (nameField) {
              const name = user.full_name || 
                          user.name || 
                          (user.email ? user.email.split('@')[0] : '') ||
                          '';
              
              if (name) {
                // Multiple ways to set the value - be very aggressive
                nameField.value = name;
                nameField.setAttribute('value', name);
                nameField.defaultValue = name;
                
                // Use Object.defineProperty to make it harder to clear
                try {
                  Object.defineProperty(nameField, 'value', {
                    value: name,
                    writable: true,
                    configurable: true
                  });
                } catch (e) {
                  // If that fails, just use normal assignment
                  nameField.value = name;
                }
                
                // Force update by dispatching events
                nameField.dispatchEvent(new Event('input', { bubbles: true }));
                nameField.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Verify it was set
                const verifyName = nameField.value;
                if (verifyName === name) {
                  console.log('‚úÖ Quick populate - Name set and verified:', verifyName);
                } else {
                  console.error('‚ùå Quick populate - Name mismatch! Set:', name, 'Got:', verifyName);
                  // Try again multiple times
                  setTimeout(() => {
                    nameField.value = name;
                    nameField.setAttribute('value', name);
                  }, 50);
                  setTimeout(() => {
                    nameField.value = name;
                    nameField.setAttribute('value', name);
                  }, 200);
                }
              } else {
                console.warn('‚ö†Ô∏è No name found in user data');
              }
            }
            
            // Populate Email - must have email
            if (emailField) {
              if (user.email) {
                // Multiple ways to set the value - be very aggressive
                emailField.value = user.email;
                emailField.setAttribute('value', user.email);
                emailField.defaultValue = user.email;
                
                // Use Object.defineProperty to make it harder to clear
                try {
                  Object.defineProperty(emailField, 'value', {
                    value: user.email,
                    writable: true,
                    configurable: true
                  });
                } catch (e) {
                  // If that fails, just use normal assignment
                  emailField.value = user.email;
                }
                
                // Force update by dispatching events
                emailField.dispatchEvent(new Event('input', { bubbles: true }));
                emailField.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Verify it was set
                const verifyEmail = emailField.value;
                if (verifyEmail === user.email) {
                  console.log('‚úÖ Quick populate - Email set and verified:', verifyEmail);
                } else {
                  console.error('‚ùå Quick populate - Email mismatch! Set:', user.email, 'Got:', verifyEmail);
                  // Try again multiple times
                  setTimeout(() => {
                    emailField.value = user.email;
                    emailField.setAttribute('value', user.email);
                  }, 50);
                  setTimeout(() => {
                    emailField.value = user.email;
                    emailField.setAttribute('value', user.email);
                  }, 200);
                }
              } else {
                console.warn('‚ö†Ô∏è No email found in user data');
              }
            }
            
            // Populate Phone
            if (phoneField && user.phone) {
              phoneField.value = user.phone;
              phoneField.setAttribute('value', user.phone);
              console.log('‚úÖ Quick populate - Phone set to:', user.phone);
            }
          } else {
            console.warn('‚ö†Ô∏è Session exists but no user object');
          }
        } catch (e) {
          console.error('‚ùå Error parsing session data:', e);
        }
      } else {
        console.warn('‚ö†Ô∏è No session data found in sessionStorage');
      }
    } catch (error) {
      console.error('‚ùå Error in populateFromSession:', error);
    }
  }

  // Populate user information from profile
  async function populateUserInfo() {
    try {
      console.log('üîÑ Starting to populate user info...');
      
      // Wait for DOM to be ready
      const nameField = document.getElementById('user-name') as HTMLInputElement;
      const emailField = document.getElementById('user-email') as HTMLInputElement;
      const phoneField = document.getElementById('user-phone') as HTMLInputElement;

      if (!nameField || !emailField || !phoneField) {
        console.warn('‚ö†Ô∏è Form fields not found, retrying in 100ms...');
        setTimeout(populateUserInfo, 100);
        return;
      }

      // Get user ID from session first
      let userId = null;
      let userEmail = '';
      let userData = null;

      // Try to get user from sessionStorage
      const sessionData = sessionStorage.getItem('simple-auth-session');
      if (sessionData) {
        try {
          const session = JSON.parse(sessionData);
          console.log('üîç Raw session data:', session);
          if (session && session.user) {
            userData = session.user;
            userId = session.user.id;
            userEmail = session.user.email || '';
            console.log('‚úÖ Found user in sessionStorage:', {
              email: userEmail,
              id: userId,
              full_name: session.user.full_name,
              name: session.user.name,
              phone: session.user.phone,
              hasFullName: !!session.user.full_name,
              hasEmail: !!session.user.email
            });
          } else {
            console.warn('‚ö†Ô∏è Session exists but no user data:', session);
          }
        } catch (e) {
          console.error('Error parsing session data:', e);
        }
      } else {
        console.warn('‚ö†Ô∏è No session data in sessionStorage');
      }

      // If no user from sessionStorage, try auth manager
      if (!userData) {
        const authManager = window.globalAuthManager || window.simpleAuthManager;
        if (authManager && authManager.isUserLoggedIn && authManager.isUserLoggedIn()) {
          userData = authManager.getCurrentUser();
          if (userData) {
            userId = userData.id;
            userEmail = userData.email || '';
            console.log('‚úÖ Found user in auth manager:', userEmail, 'ID:', userId);
          }
        }
      }

      // If still no user, try localStorage
      if (!userData) {
        const localUserData = localStorage.getItem('simple-auth-user');
        if (localUserData) {
          try {
            userData = JSON.parse(localUserData);
            userId = userData.id;
            userEmail = userData.email || '';
            console.log('‚úÖ Found user in localStorage:', userEmail, 'ID:', userId);
          } catch (e) {
            console.error('Error parsing local user data:', e);
          }
        }
      }

      // PRIORITY: Try to fetch from Supabase profiles table (most reliable)
      let profileData = null;
      if (userId) {
        const supabase = await waitForSupabase();
        if (supabase) {
          try {
            console.log('üîç Fetching profile from Supabase for user ID:', userId);
            const { data: profile, error } = await supabase
              .from('profiles')
              .select('full_name, email, phone')
              .eq('id', userId)
              .single();
            
            if (!error && profile) {
              profileData = profile;
              console.log('‚úÖ Found profile in Supabase:', {
                full_name: profile.full_name,
                email: profile.email,
                phone: profile.phone,
                hasFullName: !!profile.full_name,
                hasEmail: !!profile.email,
                hasPhone: !!profile.phone
              });
            } else {
              console.log('‚ö†Ô∏è Profile not found in Supabase or error:', error);
              // If profile doesn't exist, try to get email from auth user
              if (error && error.code === 'PGRST116') {
                console.log('‚ÑπÔ∏è Profile record does not exist, will use session data');
              }
            }
          } catch (e) {
            console.error('Error fetching from Supabase:', e);
          }
        } else {
          console.warn('‚ö†Ô∏è Supabase not available after waiting');
        }
      }

      // Log what we have before merging
      console.log('üìä Data before merging:', {
        hasProfileData: !!profileData,
        profileData: profileData,
        hasUserData: !!userData,
        userData: userData ? {
          id: userData.id,
          email: userData.email,
          full_name: userData.full_name,
          name: userData.name,
          phone: userData.phone
        } : null,
        userEmail: userEmail
      });

      // Merge profile data from Supabase with session data (prioritize Supabase but keep session fallbacks)
      let finalData = userData || {};
      if (profileData) {
        // Merge Supabase profile data, but keep session data for missing fields
        finalData = {
          ...userData,
          ...profileData,
          // Ensure we have email from somewhere - prioritize profile, then userData, then userEmail
          email: (profileData.email && profileData.email.trim()) || 
                 (userData?.email && userData.email.trim()) || 
                 (userEmail && userEmail.trim()) || 
                 '',
          // Ensure we have full_name from somewhere
          full_name: (profileData.full_name && profileData.full_name.trim()) || 
                    (userData?.full_name && userData.full_name.trim()) || 
                    (userData?.name && userData.name.trim()) || 
                    '',
          // Phone from Supabase takes priority
          phone: (profileData.phone && profileData.phone.trim()) || 
                 (userData?.phone && userData.phone.trim()) || 
                 (userData?.phone_number && userData.phone_number.trim()) || 
                 ''
        };
      } else if (userData) {
        // If no profile data, use userData directly but ensure we have email
        finalData = {
          ...userData,
          email: userData.email || userEmail || '',
          full_name: userData.full_name || userData.name || '',
          phone: userData.phone || userData.phone_number || ''
        };
      }

      console.log('üìä Final merged data:', {
        email: finalData.email,
        full_name: finalData.full_name,
        phone: finalData.phone
      });

      // Populate form fields
      if (finalData) {
        // Handle different user data structures - try multiple sources
        const userName = finalData.full_name || 
                        finalData.name || 
                        finalData.user_metadata?.full_name ||
                        (finalData.email ? finalData.email.split('@')[0] : '') || 
                        '';
        
        const finalEmail = finalData.email || 
                          userData?.email || 
                          userEmail || 
                          '';
        
        const userPhone = finalData.phone || 
                         finalData.phone_number || 
                         finalData.user_metadata?.phone ||
                         '';

        // Always set the fields, even if empty (so user can see what's missing)
        if (nameField && userName) {
          // Multiple ways to set the value to ensure it sticks
          nameField.value = userName;
          nameField.setAttribute('value', userName);
          nameField.defaultValue = userName;
          
          // Verify it was set
          const verifyName = nameField.value;
          if (verifyName === userName) {
            console.log('‚úÖ Name field populated and verified:', verifyName);
          } else {
            console.error('‚ùå Name field value mismatch! Set:', userName, 'Got:', verifyName);
            nameField.value = userName; // Try again
          }
        } else if (nameField) {
          console.warn('‚ö†Ô∏è Name is empty - checking data:', { 
            finalData, 
            userData, 
            profileData,
            userName,
            finalDataFullName: finalData.full_name,
            userDataFullName: userData?.full_name,
            profileDataFullName: profileData?.full_name
          });
        } else {
          console.error('‚ùå Name field not found in DOM');
        }

        if (emailField && finalEmail) {
          // Multiple ways to set the value to ensure it sticks
          emailField.value = finalEmail;
          emailField.setAttribute('value', finalEmail);
          emailField.defaultValue = finalEmail;
          
          // Verify it was set
          const verifyEmail = emailField.value;
          if (verifyEmail === finalEmail) {
            console.log('‚úÖ Email field populated and verified:', verifyEmail);
          } else {
            console.error('‚ùå Email field value mismatch! Set:', finalEmail, 'Got:', verifyEmail);
            emailField.value = finalEmail; // Try again
          }
        } else if (emailField) {
          console.warn('‚ö†Ô∏è Email is empty - checking data:', { 
            finalData, 
            userData, 
            profileData, 
            userEmail,
            finalDataEmail: finalData.email,
            userDataEmail: userData?.email,
            profileDataEmail: profileData?.email
          });
        } else {
          console.error('‚ùå Email field not found in DOM');
        }

        if (phoneField) {
          phoneField.value = userPhone;
          phoneField.setAttribute('value', userPhone);
          phoneField.defaultValue = userPhone;
          if (userPhone) {
            console.log('‚úÖ Phone field populated:', userPhone);
          }
        } else {
          console.error('‚ùå Phone field not found in DOM');
        }
        
        // Trigger multiple events to ensure any listeners are notified
        if (nameField && userName) {
          nameField.dispatchEvent(new Event('input', { bubbles: true }));
          nameField.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (emailField && finalEmail) {
          emailField.dispatchEvent(new Event('input', { bubbles: true }));
          emailField.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (phoneField) {
          phoneField.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Final verification after a short delay
        setTimeout(() => {
          if (nameField && userName && nameField.value !== userName) {
            console.warn('‚ö†Ô∏è Name field was cleared! Restoring...');
            nameField.value = userName;
          }
          if (emailField && finalEmail && emailField.value !== finalEmail) {
            console.warn('‚ö†Ô∏è Email field was cleared! Restoring...');
            emailField.value = finalEmail;
          }
        }, 100);

        console.log('‚úÖ User information populated successfully:', {
          name: userName,
          email: finalEmail,
          phone: userPhone,
          source: profileData ? 'Supabase' : 'Session'
        });
      } else {
        console.warn('‚ö†Ô∏è No user data found to populate form');
        console.log('Debug info:', {
          hasUserId: !!userId,
          hasUserEmail: !!userEmail,
          hasSessionStorage: !!sessionStorage.getItem('simple-auth-session'),
          hasLocalStorage: !!localStorage.getItem('simple-auth-user'),
          supabaseAvailable: !!(window as any).supabase
        });
      }
    } catch (error) {
      console.error('Error populating user info:', error);
    }
  }

  // Setup file upload handlers (called when modal is shown)
  function setupFileUploadHandlers() {
    const logoUpload = document.getElementById('logo-upload');
    const backgroundUpload = document.getElementById('background-upload');
    const introVideoUpload = document.getElementById('intro-video-upload');
    const selectLogoBtn = document.querySelector('.select-logo-btn');
    const selectBackgroundBtn = document.querySelector('.select-background-btn');
    const selectIntroVideoBtn = document.querySelector('.select-intro-video-btn');

    // Logo upload
    if (selectLogoBtn && logoUpload) {
      // Remove existing listeners by cloning
      const newSelectLogoBtn = selectLogoBtn.cloneNode(true);
      selectLogoBtn.parentNode?.replaceChild(newSelectLogoBtn, selectLogoBtn);
      
      newSelectLogoBtn.addEventListener('click', () => {
        logoUpload.click();
      });
      
      logoUpload.addEventListener('change', (e: any) => {
        const file = e.target.files[0];
        const fileNameDisplay = document.getElementById('logo-file-name');
        if (file && fileNameDisplay) {
          fileNameDisplay.textContent = `Selected: ${file.name}`;
          fileNameDisplay.classList.remove('hidden');
        }
      });
    }

    // Background upload
    if (selectBackgroundBtn && backgroundUpload) {
      const newSelectBackgroundBtn = selectBackgroundBtn.cloneNode(true);
      selectBackgroundBtn.parentNode?.replaceChild(newSelectBackgroundBtn, selectBackgroundBtn);
      
      newSelectBackgroundBtn.addEventListener('click', () => {
        backgroundUpload.click();
      });
      
      backgroundUpload.addEventListener('change', (e: any) => {
        const file = e.target.files[0];
        const fileNameDisplay = document.getElementById('background-file-name');
        if (file && fileNameDisplay) {
          fileNameDisplay.textContent = `Selected: ${file.name}`;
          fileNameDisplay.classList.remove('hidden');
        }
      });
    }

    // Intro video upload
    if (selectIntroVideoBtn && introVideoUpload) {
      const newSelectIntroVideoBtn = selectIntroVideoBtn.cloneNode(true);
      selectIntroVideoBtn.parentNode?.replaceChild(newSelectIntroVideoBtn, selectIntroVideoBtn);
      
      newSelectIntroVideoBtn.addEventListener('click', () => {
        introVideoUpload.click();
      });
      
      introVideoUpload.addEventListener('change', (e: any) => {
        const file = e.target.files[0];
        const fileNameDisplay = document.getElementById('intro-video-file-name');
        if (file && fileNameDisplay) {
          fileNameDisplay.textContent = `Selected: ${file.name}`;
          fileNameDisplay.classList.remove('hidden');
        }
      });
    }
  }

  // Form submission handler
  const customizationForm = document.getElementById('customization-form');
  if (customizationForm) {
    customizationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(customizationForm as HTMLFormElement);
      const planData = (window as any).selectedPlanData;

      if (!planData) {
        alert('Plan data not found. Please select a plan again.');
        return;
      }

      // Add plan data to form
      formData.append('productId', planData.productId);
      formData.append('productName', planData.productName);
      formData.append('price', planData.price.toString());
      formData.append('planName', planData.planName);
      formData.append('planId', planData.planId);

      console.log('üì§ Submitting customization form:', {
        productId: planData.productId,
        planName: planData.planName,
        price: planData.price,
        hasLogo: formData.has('logo'),
        hasBackground: formData.has('background'),
        hasIntroVideo: formData.has('intro_video')
      });

      // Show loading state
      const submitBtn = customizationForm.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitBtn?.textContent || 'SUBMIT AND MAKE PAYMENT';
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      try {
        // Redirect to dashboard with all the data
        const params = new URLSearchParams();
        params.set('product', planData.productId);
        params.set('price', planData.price.toString());
        params.set('planName', planData.planName);
        params.set('planId', planData.planId);
        
        // Store form data in sessionStorage for dashboard to pick up
        const customizationData = {
          logo: formData.has('logo') ? 'uploaded' : null,
          background: formData.has('background') ? 'uploaded' : null,
          introVideo: formData.has('intro_video') ? 'uploaded' : null,
          planData: planData
        };
        sessionStorage.setItem('customization-data', JSON.stringify(customizationData));

        // Redirect to dashboard
        window.location.href = `/profile?${params.toString()}`;
      } catch (error) {
        console.error('Error submitting form:', error);
        alert('An error occurred. Please try again.');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    });
  }

  // Redirect to cart functionality (kept for backward compatibility)
  window.redirectToCart = function(productId: string, price: number) {
    console.log('üõí redirectToCart called with:', { productId, price });
    
    // Check authentication using multiple methods for reliability
    const authManager = window.globalAuthManager || window.simpleAuthManager;
    const sessionData = sessionStorage.getItem('simple-auth-session');
    const hasValidSession = sessionData && sessionData !== 'null' && sessionData !== '{}';
    
    // Check if user is authenticated using auth manager
    const isLoggedInViaManager = authManager && authManager.isUserLoggedIn();
    
    // Check if user is authenticated via session storage
    let isLoggedInViaSession = false;
    if (hasValidSession) {
      try {
        const session = JSON.parse(sessionData);
        isLoggedInViaSession = session && session.user && session.access_token;
      } catch (e) {
        console.log('Session parse error:', e);
      }
    }
    
    const isAuthenticated = isLoggedInViaManager || isLoggedInViaSession;
    
    console.log('üîç Auth check:', {
      authManager: !!authManager,
      isLoggedInViaManager,
      hasValidSession,
      isLoggedInViaSession,
      isAuthenticated
    });
    
    if (isAuthenticated) {
      // User is authenticated, redirect to profile with product info
      console.log('‚úÖ User authenticated, redirecting to profile');
      const dashboardUrl = `/profile?product=${productId}&price=${price}`;
      console.log('üîó Redirecting to:', dashboardUrl);
      window.location.href = dashboardUrl;
    } else {
      // User is not authenticated, redirect to login with return URL
      console.log('‚ùå User not authenticated, redirecting to login');
      const loginUrl = `/login?redirect=/profile?product=${productId}&price=${price}`;
      console.log('üîó Redirecting to:', loginUrl);
      window.location.href = loginUrl;
    }
  };

  // Check authentication status on page load
  function checkAuthenticationStatus() {
    console.log('Checking authentication status...');
    
    // Wait for global auth manager to be ready
    const checkAuth = () => {
      const authManager = window.globalAuthManager || window.simpleAuthManager;
      
      if (authManager) {
        console.log('‚úÖ Auth manager found, checking status...');
        
        // Also check sessionStorage for valid session
        const sessionData = sessionStorage.getItem('simple-auth-session');
        const hasValidSession = sessionData && sessionData !== 'null' && sessionData !== '{}';
        const isLoggedIn = authManager.isUserLoggedIn() && hasValidSession;
        
        if (isLoggedIn) {
          console.log('‚úÖ User is authenticated, hiding login prompt');
          
          // User is authenticated, hide login prompt
          const loginPrompt = document.getElementById('login-prompt');
          if (loginPrompt) {
            loginPrompt.classList.add('hidden');
            console.log('Login prompt hidden');
          }
          
          // Hide login required messages
          hideLoginRequiredMessages();
          
          // Show authenticated user options
          const addToCartBtn = document.getElementById('add-to-cart-btn');
          if (addToCartBtn) {
            addToCartBtn.classList.remove('hidden');
            console.log('Add to cart button shown');
          }
        } else {
          console.log('‚ùå User is not authenticated, showing login prompt');
          
          // User is not authenticated, show login prompt
          const loginPrompt = document.getElementById('login-prompt');
          if (loginPrompt) {
            loginPrompt.classList.remove('hidden');
            console.log('Login prompt shown');
          }
          
          // Show login required messages
          const loginRequiredMessages = document.querySelectorAll('[id^="login-required-"]');
          loginRequiredMessages.forEach(msg => {
            if (msg instanceof HTMLElement) {
              msg.style.display = 'block';
            }
          });
          
          // Hide authenticated user options
          const addToCartBtn = document.getElementById('add-to-cart-btn');
          if (addToCartBtn) {
            addToCartBtn.classList.add('hidden');
            console.log('Add to cart button hidden');
          }
        }
      } else {
        // Auth manager not ready yet, retry after a short delay
        console.log('‚è≥ Auth manager not ready, retrying...');
        setTimeout(checkAuth, 100);
      }
    };
    
    checkAuth();
  }

  // Check authentication when page loads
  document.addEventListener('DOMContentLoaded', checkAuthenticationStatus);

  // Role-based access control for product pages
  // This runs after the inline script, so we check if user is logged in
  // IMPORTANT: ALL products require authentication - no exceptions
  document.addEventListener('DOMContentLoaded', function() {
    // Get current product slug from URL
    const currentPath = window.location.pathname;
    const productSlug = currentPath.split('/').pop();
    
    console.log('Product page loaded:', productSlug);
    
    // Check if this is Android TV App - accessible to all logged-in users
    const isAndroidTVApp = productSlug === 'android-tv-app';
    
    // List of blocked/disabled products that show dialog instead of login
    const blockedProducts = [
      'restaurant-menu-system',
      'streaming-mobile-app',
      'restaurant-website'
    ];
    
    // FIRST: Check if product is blocked - if so, show dialog and allow page view
    const isBlockedProduct = blockedProducts.includes(productSlug);
    
    if (isBlockedProduct) {
      console.log('üö´ Blocked product detected - showing dialog, allowing page view');
      // Show page content
      if (document.body) {
        document.body.style.opacity = '1';
      }
      // Show dialog
      if (window.showProductDialog) {
        window.showProductDialog();
      }
      return; // Exit early - no auth check needed
    }
    
    // ALL products require authentication - no bypasses
    // Check if we're still on this page (not redirected)
    if (window.location.pathname !== currentPath) {
      return; // Already redirected
    }
    
    // Check authentication and admin status (for all products)
    const authManager = window.globalAuthManager || window.simpleAuthManager;
    const sessionData = sessionStorage.getItem('simple-auth-session');
    const hasValidSession = sessionData && sessionData !== 'null' && sessionData !== '{}';
    
    const isLoggedIn = authManager && authManager.isUserLoggedIn() && hasValidSession;
    
    if (!isLoggedIn) {
      // User not logged in - redirect to login immediately
      // This is a critical security check - no product access without login
      console.log('‚ùå User not logged in - redirecting to login (authentication required)');
      const loginUrl = `/login?redirect=${encodeURIComponent(currentPath)}`;
      
      // Smooth fade-out transition
      if (document.body) {
        document.body.style.transition = 'opacity 0.3s ease-out';
        document.body.style.opacity = '0';
      }
      if (document.documentElement) {
        document.documentElement.style.transition = 'opacity 0.3s ease-out';
        document.documentElement.style.opacity = '0';
      }
      
      setTimeout(() => {
        window.location.href = loginUrl;
      }, 200);
      return;
    }
    
    // User is logged in - check if Android TV App
    if (isAndroidTVApp) {
      // Android TV App - allow access for all logged-in users
      console.log('‚úÖ Android TV App - allowing access for logged-in user');
      if (document.body) {
        document.body.style.opacity = '1';
      }
      if (document.documentElement) {
        document.documentElement.style.opacity = '1';
      }
      return;
    }
    
    // User is logged in - check admin status
    const isAdmin = checkIfUserIsAdmin();
    console.log('Is admin:', isAdmin);
    
    if (!isAdmin) {
      // Logged in but not admin - show dialog or redirect (for other products)
      console.log('Non-admin user - showing dialog');
      // Show content for non-admin users (they'll see the dialog)
      if (document.body) {
        document.body.style.opacity = '1';
      }
      if (window.showProductDialog) {
        window.showProductDialog();
      } else {
        console.log('Dialog not available - redirecting to contact');
        window.location.href = '/contact';
      }
    } else {
      // Admin user - show content without restrictions
      console.log('Admin user - no restrictions');
      if (document.body) {
        document.body.style.opacity = '1';
      }
    }
    
    // Hide "Login required to select" message if user is logged in
    const loginRequiredMessages = document.querySelectorAll('[id^="login-required-"]');
    loginRequiredMessages.forEach(msg => {
      if (msg instanceof HTMLElement) {
        msg.style.display = 'none';
      }
    });
  });
  
  // Also check login status on page load and hide login required messages
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for auth manager to initialize
    setTimeout(() => {
      const authManager = window.globalAuthManager || window.simpleAuthManager;
      const sessionData = sessionStorage.getItem('simple-auth-session');
      const hasValidSession = sessionData && sessionData !== 'null' && sessionData !== '{}';
      const isLoggedIn = authManager && authManager.isUserLoggedIn() && hasValidSession;
      
      if (isLoggedIn) {
        // User is logged in - hide all "Login required" messages
        const loginRequiredMessages = document.querySelectorAll('[id^="login-required-"]');
        loginRequiredMessages.forEach(msg => {
          if (msg instanceof HTMLElement) {
            msg.style.display = 'none';
          }
        });
        console.log('‚úÖ User is logged in - hiding login required messages');
      } else {
        // User is not logged in - show login required messages
        const loginRequiredMessages = document.querySelectorAll('[id^="login-required-"]');
        loginRequiredMessages.forEach(msg => {
          if (msg instanceof HTMLElement) {
            msg.style.display = 'block';
          }
        });
        console.log('‚ùå User is not logged in - showing login required messages');
      }
    }, 500);
  });

  // Function to check if user is admin - deployment compatible
  function checkIfUserIsAdmin() {
    try {
      // Check global auth manager first
      if (window.globalAuthManager && window.globalAuthManager.isUserLoggedIn()) {
        const currentUser = window.globalAuthManager.getCurrentUser();
        if (currentUser && currentUser.role === 'admin') {
          return true;
        }
      }
      
      // Check simple auth manager
      if (window.simpleAuthManager && window.simpleAuthManager.isUserLoggedIn()) {
        const currentUser = window.simpleAuthManager.getCurrentUser();
        if (currentUser && currentUser.role === 'admin') {
          return true;
        }
      }
      
      // Check session storage for admin role
      const sessionData = sessionStorage.getItem('simple-auth-session');
      if (sessionData) {
        try {
          const session = JSON.parse(sessionData);
          if (session.user && session.user.role === 'admin') {
            return true;
          }
        } catch (parseError) {
          console.log('Session data parse error:', parseError);
        }
      }
      
      // Check localStorage as fallback
      const localSessionData = localStorage.getItem('simple-auth-session');
      if (localSessionData) {
        try {
          const session = JSON.parse(localSessionData);
          if (session.user && session.user.role === 'admin') {
            return true;
          }
        } catch (parseError) {
          console.log('Local session data parse error:', parseError);
        }
      }
      
      return false;
    } catch (error) {
      console.error('Error checking admin status:', error);
      return false;
    }
  }

  // Listen for authentication state changes
  // Hide login required messages when user logs in
  function hideLoginRequiredMessages() {
    const loginRequiredMessages = document.querySelectorAll('[id^="login-required-"]');
    loginRequiredMessages.forEach(msg => {
      if (msg instanceof HTMLElement) {
        msg.style.display = 'none';
      }
    });
    console.log('‚úÖ Hiding login required messages - user is logged in');
  }
  
  window.addEventListener('user-logged-in', (e) => {
    hideLoginRequiredMessages();
    console.log('‚úÖ User logged in event received, updating UI...');
    checkAuthenticationStatus();
  });

  window.addEventListener('user-logged-out', () => {
    console.log('‚ùå User logged out event received, updating UI...');
    // Show login required messages when user logs out
    const loginRequiredMessages = document.querySelectorAll('[id^="login-required-"]');
    loginRequiredMessages.forEach(msg => {
      if (msg instanceof HTMLElement) {
        msg.style.display = 'block';
      }
    });
    checkAuthenticationStatus();
  });

  // Animation on scroll
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('animate-fade-in');
      }
    });
  });

  document.querySelectorAll('.animate-fade-in').forEach(el => {
    observer.observe(el);
  });

  // Ensure Contact Us button text visibility
  // Real-time subscriptions storage
  let productDetailRealtimeSubscriptions = [];

  // Fetch product from Supabase and update prices dynamically
  async function updateProductDetailPrices() {
    try {
      // Wait for Supabase to be available
      let supabaseClient = null;
      if (window.supabase && window.supabase.auth) {
        supabaseClient = window.supabase;
      } else {
        await new Promise(resolve => setTimeout(resolve, 500));
        if (window.supabase && window.supabase.auth) {
          supabaseClient = window.supabase;
        }
      }

      if (!supabaseClient) {
        console.warn('‚ö†Ô∏è Supabase not available for fetching product');
        return;
      }

      // Get product slug from URL
      const currentPath = window.location.pathname;
      const slug = currentPath.split('/').pop();

      if (!slug) {
        console.warn('‚ö†Ô∏è Could not determine product slug');
        return;
      }

      console.log('üîÑ Fetching latest product data from Supabase for:', slug);
      
      // Fetch product from Supabase
      const { data: product, error: productError } = await supabaseClient
        .from('products')
        .select(`
          *,
          product_plans (*)
        `)
        .eq('slug', slug)
        .eq('is_active', true)
        .single();

      if (productError) {
        console.error('‚ùå Error fetching product:', productError);
        return;
      }

      if (!product) {
        console.warn('‚ö†Ô∏è Product not found in Supabase');
        return;
      }

      console.log('‚úÖ Fetched product from Supabase:', product.name);

      // Update base price
      const basePriceElement = document.querySelector('.text-2xl.font-bold.text-gray-900');
      if (basePriceElement && product.base_price) {
        const oldPrice = basePriceElement.textContent;
        const isAndroidTVApp = product.slug === 'android-tv-app';
        const newPrice = isAndroidTVApp ? '¬£99.00' : `‚Çπ${Number(product.base_price).toLocaleString('en-IN')}`;
        
        // Only update if price actually changed
        if (oldPrice !== newPrice) {
          basePriceElement.textContent = newPrice;
          console.log(`‚úÖ Updated base price: ${oldPrice} ‚Üí ${newPrice}`);
          
          // Add animation
          basePriceElement.style.transition = 'all 0.3s ease';
          basePriceElement.style.transform = 'scale(1.1)';
          basePriceElement.style.color = '#10b981';
          setTimeout(() => {
            basePriceElement.style.transform = 'scale(1)';
            basePriceElement.style.color = '';
          }, 300);
        }
      }

      // Update product plans prices
      if (product.product_plans && product.product_plans.length > 0) {
        const isAndroidTVApp = product.slug === 'android-tv-app';
        product.product_plans.forEach((plan, index) => {
          // Find plan price elements - they might have different structures
          const planPriceElements = document.querySelectorAll('.text-3xl.font-bold.text-primary-600');
          if (planPriceElements[index]) {
            const oldPrice = planPriceElements[index].textContent;
            let newPrice;
            if (isAndroidTVApp) {
              if (plan.name === 'Standard') {
                newPrice = '¬£99.00';
              } else if (plan.name === 'Pro') {
                newPrice = '¬£299.00';
              } else if (plan.name === 'Pro Gold') {
                newPrice = '¬£449.00';
              } else {
                newPrice = `‚Çπ${Number(plan.price).toLocaleString('en-IN')}`;
              }
            } else {
              newPrice = `‚Çπ${Number(plan.price).toLocaleString('en-IN')}`;
            }
            planPriceElements[index].textContent = newPrice;
            console.log(`‚úÖ Updated plan ${plan.name} price: ${oldPrice} ‚Üí ${newPrice}`);
            
            // Add animation
            planPriceElements[index].style.transition = 'all 0.3s ease';
            planPriceElements[index].style.transform = 'scale(1.1)';
            planPriceElements[index].style.color = '#10b981';
            setTimeout(() => {
              planPriceElements[index].style.transform = 'scale(1)';
              planPriceElements[index].style.color = '';
            }, 300);
          }
        });
      }

      console.log('‚úÖ Product prices updated successfully');
    } catch (error) {
      console.error('‚ùå Error updating product prices:', error);
    }
  }

  // Setup real-time subscriptions for product detail
  async function setupProductDetailRealtime() {
    try {
      // Wait for Supabase to be available
      let supabaseClient = null;
      if (window.supabase && window.supabase.auth) {
        supabaseClient = window.supabase;
      } else {
        await new Promise(resolve => setTimeout(resolve, 1000));
        if (window.supabase && window.supabase.auth) {
          supabaseClient = window.supabase;
        }
      }

      if (!supabaseClient) {
        console.warn('‚ö†Ô∏è Supabase not available for real-time subscriptions');
        return;
      }

      // Import real-time utility
      const { subscribeToTable } = await import('../../lib/realtime');
      
      // Subscribe to products table changes
      const productsSub = subscribeToTable('products', (payload) => {
        console.log('üîÑ Real-time update received for products:', payload.eventType);
        // Update prices dynamically
        if (window.productDetailUpdateTimeout) {
          clearTimeout(window.productDetailUpdateTimeout);
        }
        window.productDetailUpdateTimeout = setTimeout(() => {
          console.log('üîÑ Updating product prices from Supabase...');
          updateProductDetailPrices();
        }, 500);
      });

      productDetailRealtimeSubscriptions.push(productsSub);

      // Subscribe to product_plans table changes
      const plansSub = subscribeToTable('product_plans', (payload) => {
        console.log('üîÑ Real-time update received for product_plans:', payload.eventType);
        // Update prices dynamically
        if (window.productDetailUpdateTimeout) {
          clearTimeout(window.productDetailUpdateTimeout);
        }
        window.productDetailUpdateTimeout = setTimeout(() => {
          console.log('üîÑ Updating product prices from Supabase...');
          updateProductDetailPrices();
        }, 500);
      });

      productDetailRealtimeSubscriptions.push(plansSub);

      // Also fetch and update prices on page load
      updateProductDetailPrices();

      console.log('‚úÖ Real-time subscriptions setup complete for product detail');
    } catch (error) {
      console.error('‚ùå Error setting up real-time subscriptions for product detail:', error);
    }
  }

  // Cleanup subscriptions on page unload
  window.addEventListener('beforeunload', () => {
    if (productDetailRealtimeSubscriptions.length > 0) {
      productDetailRealtimeSubscriptions.forEach(sub => {
        if (sub && sub.unsubscribe) {
          sub.unsubscribe();
        }
      });
    }
    if (window.productDetailUpdateTimeout) {
      clearTimeout(window.productDetailUpdateTimeout);
    }
  });

  // Handle product image errors with fallback
  const fallbackImages: Record<string, string> = {
    'restaurant-menu-system': 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop&crop=center',
    'android-tv-app': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=300&fit=crop&crop=center',
    'streaming-mobile-app': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=300&fit=crop&crop=center',
    'restaurant-website': 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop&crop=center'
  };

  const defaultFallback = 'https://images.unsplash.com/photo-1551434678-e076c223a692?w=400&h=300&fit=crop&crop=center';

  document.addEventListener('DOMContentLoaded', () => {
    // Setup real-time subscriptions for product detail
    setupProductDetailRealtime();
    
    // Handle product image errors
    const productImage = document.querySelector('.product-detail-image') as HTMLImageElement;
    if (productImage && !productImage.hasAttribute('data-error-handled')) {
      productImage.setAttribute('data-error-handled', 'true');
      productImage.addEventListener('error', function() {
        const productSlug = this.getAttribute('data-product-slug');
        if (productSlug && fallbackImages[productSlug]) {
          this.src = fallbackImages[productSlug];
        } else {
          this.src = defaultFallback;
        }
      });
      
      // Check if image failed to load initially
      if (!productImage.complete || productImage.naturalHeight === 0) {
        productImage.dispatchEvent(new Event('error'));
      }
    }
    
    const contactButtons = document.querySelectorAll('.contact-us-btn');
    contactButtons.forEach(button => {
      button.addEventListener('mouseenter', function() {
        this.style.color = '#000000';
        this.style.backgroundColor = 'white';
      });
      button.addEventListener('mouseleave', function() {
        this.style.color = 'white';
        this.style.backgroundColor = 'transparent';
      });
    });
  });
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
    opacity: 0;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .rotate-180 {
    transform: rotate(180deg);
  }

  /* Customization Modal Styles */
  #customization-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
  }

  #customization-modal:not(.hidden) {
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  #customization-modal.hidden {
    display: none !important;
  }

  /* Contact Us button text visibility - More specific selectors */
  a.contact-us-btn {
    color: white !important;
  }
  
  a.contact-us-btn:hover {
    color: #000000 !important; /* Black text on white background */
    background-color: white !important;
  }
  
  a.contact-us-btn:focus {
    color: #000000 !important; /* Black text on focus */
    background-color: white !important;
  }
  
  /* Additional specificity for hover state */
  .contact-us-btn:hover span,
  .contact-us-btn:hover {
    color: #000000 !important;
  }
</style>